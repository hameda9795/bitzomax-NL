<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Authentication - BitzoMax Live</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        input { width: 200px; padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Debug Authentication Persistence - BitzoMax.nl</h1>
        
        <div class="section">
            <h3>🎯 هدف تست</h3>
            <p><strong>مشکل:</strong> بعد از refresh صفحه، باید دوباره login کرد</p>
            <p><strong>انتظار:</strong> بعد از login و refresh، هنوز logged in باشیم</p>
        </div>

        <div class="section">
            <h3>1️⃣ چک کردن localStorage</h3>
            <button onclick="checkLocalStorage()">Check localStorage</button>
            <div id="localStorageResult" class="log"></div>
        </div>

        <div class="section">
            <h3>2️⃣ تست Login</h3>
            <input type="text" id="username" placeholder="Username" value="admin">
            <input type="password" id="password" placeholder="Password" value="admin123">
            <button onclick="testLogin()">Test Login</button>
            <div id="loginResult" class="log"></div>
        </div>

        <div class="section">
            <h3>3️⃣ تست کریتیکال: شبیه‌سازی Refresh</h3>
            <button onclick="simulateRefresh()">Simulate Page Refresh</button>
            <button onclick="location.reload()">Actual Page Refresh</button>
            <div id="refreshResult" class="log"></div>
        </div>

        <div class="section">
            <h3>4️⃣ Console Logs در حال اجرا</h3>
            <div id="consoleLogs" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://bitzomax.nl/api';
        const TOKEN_KEY = 'auth-token';
        const USER_KEY = 'auth-user';

        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function appendToConsole(message) {
            const consoleDiv = document.getElementById('consoleLogs');
            const timestamp = new Date().toLocaleTimeString();
            consoleDiv.textContent += `[${timestamp}] ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            appendToConsole('LOG: ' + args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            appendToConsole('ERROR: ' + args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            appendToConsole('WARN: ' + args.join(' '));
        };

        function updateResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function checkLocalStorage() {
            updateResult('localStorageResult', '🔍 بررسی localStorage...');
            
            const token = localStorage.getItem(TOKEN_KEY);
            const user = localStorage.getItem(USER_KEY);
            
            updateResult('localStorageResult', `🔑 Token exists: ${!!token}`);
            updateResult('localStorageResult', `👤 User exists: ${!!user}`);
            
            if (token) {
                updateResult('localStorageResult', `🔑 Token preview: ${token.substring(0, 50)}...`);
            }
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    updateResult('localStorageResult', `👤 User: ${userData.username} (${userData.email})`);
                    updateResult('localStorageResult', `🎭 Roles: ${userData.roles?.join(', ') || 'none'}`);
                } catch (e) {
                    updateResult('localStorageResult', `❌ Error parsing user: ${e.message}`);
                }
            }
            
            const isAuthenticated = !!(token && user);
            updateResult('localStorageResult', `✅ Overall auth state: ${isAuthenticated}`);
            
            return isAuthenticated;
        }

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            updateResult('loginResult', `🔐 تست login برای: ${username}`);
            
            try {
                const response = await fetch(`${API_BASE}/auth/signin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                updateResult('loginResult', `📡 Response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    updateResult('loginResult', `✅ Login موفقیت‌آمیز!`);
                    updateResult('loginResult', `🔑 Token received: ${data.accessToken?.substring(0, 30)}...`);
                    
                    // Save to localStorage
                    localStorage.setItem(TOKEN_KEY, data.accessToken);
                    localStorage.setItem(USER_KEY, JSON.stringify(data));
                    updateResult('loginResult', `💾 داده‌ها در localStorage ذخیره شدند`);
                    
                    // Verify immediately
                    setTimeout(() => {
                        const savedToken = localStorage.getItem(TOKEN_KEY);
                        const savedUser = localStorage.getItem(USER_KEY);
                        updateResult('loginResult', `🔍 بررسی فوری - Token: ${!!savedToken}, User: ${!!savedUser}`);
                        
                        if (savedToken && savedUser) {
                            updateResult('loginResult', `✅ تأیید: داده‌ها موفقیت‌آمیز ذخیره شدند!`);
                        } else {
                            updateResult('loginResult', `❌ خطا: داده‌ها ذخیره نشدند!`);
                        }
                    }, 500);
                    
                } else {
                    const errorText = await response.text();
                    updateResult('loginResult', `❌ Login ناموفق: ${errorText}`);
                }
            } catch (error) {
                updateResult('loginResult', `❌ خطای شبکه: ${error.message}`);
            }
        }

        function simulateRefresh() {
            updateResult('refreshResult', '🔄 شبیه‌سازی refresh...');
            
            // Check current state
            const beforeToken = localStorage.getItem(TOKEN_KEY);
            const beforeUser = localStorage.getItem(USER_KEY);
            
            updateResult('refreshResult', `📊 قبل از refresh - Token: ${!!beforeToken}, User: ${!!beforeUser}`);
            
            if (!beforeToken || !beforeUser) {
                updateResult('refreshResult', '⚠️ هیچ داده authentication پیدا نشد. اول login کنید.');
                return;
            }
            
            // Simulate what happens during refresh
            updateResult('refreshResult', '🔄 شبیه‌سازی loading صفحه...');
            
            setTimeout(() => {
                // Check if data persists
                const afterToken = localStorage.getItem(TOKEN_KEY);
                const afterUser = localStorage.getItem(USER_KEY);
                
                updateResult('refreshResult', `📊 بعد از شبیه‌سازی - Token: ${!!afterToken}, User: ${!!afterUser}`);
                
                const persistent = !!(beforeToken && afterToken && beforeUser && afterUser);
                const dataIntact = (beforeToken === afterToken && beforeUser === afterUser);
                
                if (persistent && dataIntact) {
                    updateResult('refreshResult', '✅ داده‌های authentication سالم هستند!');
                    updateResult('refreshResult', '✅ تست شبیه‌سازی refresh موفقیت‌آمیز!');
                } else {
                    updateResult('refreshResult', '❌ مشکل در persistence داده‌ها!');
                    updateResult('refreshResult', `❌ Persistent: ${persistent}, Data intact: ${dataIntact}`);
                }
                
                // Test what AuthService would do
                updateResult('refreshResult', '🔍 تست منطق AuthService...');
                const hasValidToken = !!afterToken && afterToken.length > 0;
                const hasValidUser = !!afterUser;
                const shouldBeAuthenticated = hasValidToken && hasValidUser;
                
                updateResult('refreshResult', `🔍 AuthService logic:`);
                updateResult('refreshResult', `  - hasValidToken: ${hasValidToken}`);
                updateResult('refreshResult', `  - hasValidUser: ${hasValidUser}`);
                updateResult('refreshResult', `  - shouldBeAuthenticated: ${shouldBeAuthenticated}`);
                
                if (shouldBeAuthenticated) {
                    updateResult('refreshResult', '✅ AuthService باید user را authenticated تشخیص دهد');
                } else {
                    updateResult('refreshResult', '❌ AuthService user را authenticated تشخیص نمی‌دهد');
                }
                
            }, 1000);
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('🚀 صفحه debug بارگذاری شد');
            updateResult('consoleLogs', 'Debug page loaded - checking initial state...');
            checkLocalStorage();
        });

        // Monitor localStorage changes
        let lastTokenCheck = localStorage.getItem(TOKEN_KEY);
        let lastUserCheck = localStorage.getItem(USER_KEY);
        
        setInterval(() => {
            const currentToken = localStorage.getItem(TOKEN_KEY);
            const currentUser = localStorage.getItem(USER_KEY);
            
            if (currentToken !== lastTokenCheck || currentUser !== lastUserCheck) {
                console.log('🔄 localStorage تغییر کرد!');
                console.log(`Token changed: ${lastTokenCheck !== currentToken}`);
                console.log(`User changed: ${lastUserCheck !== currentUser}`);
                
                lastTokenCheck = currentToken;
                lastUserCheck = currentUser;
            }
        }, 2000);
    </script>
</body>
</html>
