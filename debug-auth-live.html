<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Authentication - BitzoMax Live</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        input { width: 200px; padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Debug Authentication Persistence - BitzoMax.nl</h1>
        
        <div class="section">
            <h3>ğŸ¯ Ù‡Ø¯Ù ØªØ³Øª</h3>
            <p><strong>Ù…Ø´Ú©Ù„:</strong> Ø¨Ø¹Ø¯ Ø§Ø² refresh ØµÙØ­Ù‡ØŒ Ø¨Ø§ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ login Ú©Ø±Ø¯</p>
            <p><strong>Ø§Ù†ØªØ¸Ø§Ø±:</strong> Ø¨Ø¹Ø¯ Ø§Ø² login Ùˆ refreshØŒ Ù‡Ù†ÙˆØ² logged in Ø¨Ø§Ø´ÛŒÙ…</p>
        </div>

        <div class="section">
            <h3>1ï¸âƒ£ Ú†Ú© Ú©Ø±Ø¯Ù† localStorage</h3>
            <button onclick="checkLocalStorage()">Check localStorage</button>
            <div id="localStorageResult" class="log"></div>
        </div>

        <div class="section">
            <h3>2ï¸âƒ£ ØªØ³Øª Login</h3>
            <input type="text" id="username" placeholder="Username" value="admin">
            <input type="password" id="password" placeholder="Password" value="admin123">
            <button onclick="testLogin()">Test Login</button>
            <div id="loginResult" class="log"></div>
        </div>

        <div class="section">
            <h3>3ï¸âƒ£ ØªØ³Øª Ú©Ø±ÛŒØªÛŒÚ©Ø§Ù„: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Refresh</h3>
            <button onclick="simulateRefresh()">Simulate Page Refresh</button>
            <button onclick="location.reload()">Actual Page Refresh</button>
            <div id="refreshResult" class="log"></div>
        </div>

        <div class="section">
            <h3>4ï¸âƒ£ Console Logs Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§</h3>
            <div id="consoleLogs" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://bitzomax.nl/api';
        const TOKEN_KEY = 'auth-token';
        const USER_KEY = 'auth-user';

        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function appendToConsole(message) {
            const consoleDiv = document.getElementById('consoleLogs');
            const timestamp = new Date().toLocaleTimeString();
            consoleDiv.textContent += `[${timestamp}] ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            appendToConsole('LOG: ' + args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            appendToConsole('ERROR: ' + args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            appendToConsole('WARN: ' + args.join(' '));
        };

        function updateResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function checkLocalStorage() {
            updateResult('localStorageResult', 'ğŸ” Ø¨Ø±Ø±Ø³ÛŒ localStorage...');
            
            const token = localStorage.getItem(TOKEN_KEY);
            const user = localStorage.getItem(USER_KEY);
            
            updateResult('localStorageResult', `ğŸ”‘ Token exists: ${!!token}`);
            updateResult('localStorageResult', `ğŸ‘¤ User exists: ${!!user}`);
            
            if (token) {
                updateResult('localStorageResult', `ğŸ”‘ Token preview: ${token.substring(0, 50)}...`);
            }
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    updateResult('localStorageResult', `ğŸ‘¤ User: ${userData.username} (${userData.email})`);
                    updateResult('localStorageResult', `ğŸ­ Roles: ${userData.roles?.join(', ') || 'none'}`);
                } catch (e) {
                    updateResult('localStorageResult', `âŒ Error parsing user: ${e.message}`);
                }
            }
            
            const isAuthenticated = !!(token && user);
            updateResult('localStorageResult', `âœ… Overall auth state: ${isAuthenticated}`);
            
            return isAuthenticated;
        }

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            updateResult('loginResult', `ğŸ” ØªØ³Øª login Ø¨Ø±Ø§ÛŒ: ${username}`);
            
            try {
                const response = await fetch(`${API_BASE}/auth/signin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                updateResult('loginResult', `ğŸ“¡ Response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    updateResult('loginResult', `âœ… Login Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²!`);
                    updateResult('loginResult', `ğŸ”‘ Token received: ${data.accessToken?.substring(0, 30)}...`);
                    
                    // Save to localStorage
                    localStorage.setItem(TOKEN_KEY, data.accessToken);
                    localStorage.setItem(USER_KEY, JSON.stringify(data));
                    updateResult('loginResult', `ğŸ’¾ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯`);
                    
                    // Verify immediately
                    setTimeout(() => {
                        const savedToken = localStorage.getItem(TOKEN_KEY);
                        const savedUser = localStorage.getItem(USER_KEY);
                        updateResult('loginResult', `ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙÙˆØ±ÛŒ - Token: ${!!savedToken}, User: ${!!savedUser}`);
                        
                        if (savedToken && savedUser) {
                            updateResult('loginResult', `âœ… ØªØ£ÛŒÛŒØ¯: Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯!`);
                        } else {
                            updateResult('loginResult', `âŒ Ø®Ø·Ø§: Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù†Ø¯!`);
                        }
                    }, 500);
                    
                } else {
                    const errorText = await response.text();
                    updateResult('loginResult', `âŒ Login Ù†Ø§Ù…ÙˆÙÙ‚: ${errorText}`);
                }
            } catch (error) {
                updateResult('loginResult', `âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${error.message}`);
            }
        }

        function simulateRefresh() {
            updateResult('refreshResult', 'ğŸ”„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ refresh...');
            
            // Check current state
            const beforeToken = localStorage.getItem(TOKEN_KEY);
            const beforeUser = localStorage.getItem(USER_KEY);
            
            updateResult('refreshResult', `ğŸ“Š Ù‚Ø¨Ù„ Ø§Ø² refresh - Token: ${!!beforeToken}, User: ${!!beforeUser}`);
            
            if (!beforeToken || !beforeUser) {
                updateResult('refreshResult', 'âš ï¸ Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡ authentication Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ø§ÙˆÙ„ login Ú©Ù†ÛŒØ¯.');
                return;
            }
            
            // Simulate what happens during refresh
            updateResult('refreshResult', 'ğŸ”„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ loading ØµÙØ­Ù‡...');
            
            setTimeout(() => {
                // Check if data persists
                const afterToken = localStorage.getItem(TOKEN_KEY);
                const afterUser = localStorage.getItem(USER_KEY);
                
                updateResult('refreshResult', `ğŸ“Š Ø¨Ø¹Ø¯ Ø§Ø² Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ - Token: ${!!afterToken}, User: ${!!afterUser}`);
                
                const persistent = !!(beforeToken && afterToken && beforeUser && afterUser);
                const dataIntact = (beforeToken === afterToken && beforeUser === afterUser);
                
                if (persistent && dataIntact) {
                    updateResult('refreshResult', 'âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ authentication Ø³Ø§Ù„Ù… Ù‡Ø³ØªÙ†Ø¯!');
                    updateResult('refreshResult', 'âœ… ØªØ³Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ refresh Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²!');
                } else {
                    updateResult('refreshResult', 'âŒ Ù…Ø´Ú©Ù„ Ø¯Ø± persistence Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§!');
                    updateResult('refreshResult', `âŒ Persistent: ${persistent}, Data intact: ${dataIntact}`);
                }
                
                // Test what AuthService would do
                updateResult('refreshResult', 'ğŸ” ØªØ³Øª Ù…Ù†Ø·Ù‚ AuthService...');
                const hasValidToken = !!afterToken && afterToken.length > 0;
                const hasValidUser = !!afterUser;
                const shouldBeAuthenticated = hasValidToken && hasValidUser;
                
                updateResult('refreshResult', `ğŸ” AuthService logic:`);
                updateResult('refreshResult', `  - hasValidToken: ${hasValidToken}`);
                updateResult('refreshResult', `  - hasValidUser: ${hasValidUser}`);
                updateResult('refreshResult', `  - shouldBeAuthenticated: ${shouldBeAuthenticated}`);
                
                if (shouldBeAuthenticated) {
                    updateResult('refreshResult', 'âœ… AuthService Ø¨Ø§ÛŒØ¯ user Ø±Ø§ authenticated ØªØ´Ø®ÛŒØµ Ø¯Ù‡Ø¯');
                } else {
                    updateResult('refreshResult', 'âŒ AuthService user Ø±Ø§ authenticated ØªØ´Ø®ÛŒØµ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯');
                }
                
            }, 1000);
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('ğŸš€ ØµÙØ­Ù‡ debug Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
            updateResult('consoleLogs', 'Debug page loaded - checking initial state...');
            checkLocalStorage();
        });

        // Monitor localStorage changes
        let lastTokenCheck = localStorage.getItem(TOKEN_KEY);
        let lastUserCheck = localStorage.getItem(USER_KEY);
        
        setInterval(() => {
            const currentToken = localStorage.getItem(TOKEN_KEY);
            const currentUser = localStorage.getItem(USER_KEY);
            
            if (currentToken !== lastTokenCheck || currentUser !== lastUserCheck) {
                console.log('ğŸ”„ localStorage ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!');
                console.log(`Token changed: ${lastTokenCheck !== currentToken}`);
                console.log(`User changed: ${lastUserCheck !== currentUser}`);
                
                lastTokenCheck = currentToken;
                lastUserCheck = currentUser;
            }
        }, 2000);
    </script>
</body>
</html>
